<div class="bg-white p-6 rounded-lg shadow-md">
    <h1 class="text-2xl font-semibold mb-6">S·ª≠a B√†i vi·∫øt</h1>
    
    <form action="/admin/posts/edit/{{post._id}}" method="POST" enctype="multipart/form-data" class="space-y-4">
        <!-- Title -->
        <div>
            <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
                Ti√™u ƒë·ªÅ <span class="text-red-500">*</span>
            </label>
            <input 
                type="text" 
                id="title" 
                name="title" 
                value="{{post.title}}"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="Nh·∫≠p ti√™u ƒë·ªÅ b√†i vi·∫øt...">
        </div>

        <!-- Slug -->
        <div>
            <label for="slug" class="block text-sm font-medium text-gray-700 mb-2">
                Slug <span class="text-red-500">*</span>
            </label>
            <input 
                type="text" 
                id="slug" 
                name="slug"
                value="{{post.slug}}"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="bai-viet-cua-toi">
        </div>

        <!-- Category -->
        <div>
            <label for="category" class="block text-sm font-medium text-gray-700 mb-2">
                Danh m·ª•c <span class="text-red-500">*</span>
            </label>
            <select 
                id="category" 
                name="category" 
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">-- Ch·ªçn danh m·ª•c --</option>
                {{#each categories}}
                    <option value="{{this._id}}" {{#ifEqual this._id ../post.category._id}}selected{{/ifEqual}}>
                        {{this.name}}
                    </option>
                {{/each}}
            </select>
        </div>

        <!-- Current Thumbnail -->
        {{#if post.thumbnail}}
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
                Thumbnail hi·ªán t·∫°i
            </label>
            <img src="{{post.thumbnail}}" alt="Current thumbnail" class="w-48 h-48 object-cover rounded border">
        </div>
        {{/if}}

        <!-- New Thumbnail -->
        <div>
            <label for="thumbnail" class="block text-sm font-medium text-gray-700 mb-2">
                ·∫¢nh Thumbnail m·ªõi (ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi)
            </label>
            <input 
                type="file" 
                id="thumbnail" 
                name="thumbnail"
                accept="image/*"
                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <p class="mt-1 text-sm text-gray-500">·∫¢nh ƒë·∫°i di·ªán cho b√†i vi·∫øt (JPEG, PNG, GIF, WEBP - Max 5MB)</p>
        </div>

        <!-- Status -->
        <div>
            <label for="status" class="block text-sm font-medium text-gray-700 mb-2">
                Tr·∫°ng th√°i
            </label>
            <select 
                id="status" 
                name="status"
                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="draft" {{#ifEqual post.status "draft"}}selected{{/ifEqual}}>Nh√°p</option>
                <option value="published" {{#ifEqual post.status "published"}}selected{{/ifEqual}}>Xu·∫•t b·∫£n</option>
                <option value="hidden" {{#ifEqual post.status "hidden"}}selected{{/ifEqual}}>·∫®n</option>
            </select>
        </div>

        <!-- Content (CKEditor) -->
        <div>
            <label for="content" class="block text-sm font-medium text-gray-700 mb-2">
                N·ªôi dung <span class="text-red-500">*</span>
            </label>
            <textarea 
                id="content" 
                name="content" 
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-md">{{{post.content}}}</textarea>
        </div>

        <!-- Metadata -->
        <div class="bg-gray-50 p-4 rounded-md">
            <p class="text-sm text-gray-600">
                <strong>T·∫°o l√∫c:</strong> {{formatDate post.createdAt}}
            </p>
            <p class="text-sm text-gray-600">
                <strong>C·∫≠p nh·∫≠t:</strong> {{formatDate post.updatedAt}}
            </p>
            <p class="text-sm text-gray-600">
                <strong>T√°c gi·∫£:</strong> {{post.author.name}} 
            </p>
        </div>

        <!-- Buttons -->
        <div class="flex gap-3 pt-4">
            <button 
                type="submit" 
                class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-colors">
                C·∫≠p nh·∫≠t
            </button>
            <a 
                href="/admin/posts" 
                class="bg-gray-300 text-gray-700 px-6 py-2 rounded-md hover:bg-gray-400 transition-colors">
                H·ªßy
            </a>
        </div>
    </form>
</div>

<!-- CKEditor 4 - Full Featured WYSIWYG Editor -->
<script src="https://cdn.ckeditor.com/4.22.1/full/ckeditor.js"></script>
<script>
    // Get initial content from textarea BEFORE replacing it
    var initialContent = document.getElementById('content').value;
    console.log('üìÑ Initial textarea content length:', initialContent.length);
    
    // Initialize CKEditor
    var editor = CKEDITOR.replace('content', {
        height: 450,
        language: 'vi',
        
        // Full toolbar configuration
        toolbar: [
            { name: 'document', items: ['Source', '-', 'Save', 'NewPage', 'Preview', 'Print'] },
            { name: 'clipboard', items: ['Cut', 'Copy', 'Paste', 'PasteText', 'PasteFromWord', '-', 'Undo', 'Redo'] },
            { name: 'editing', items: ['Find', 'Replace', '-', 'SelectAll', '-', 'Scayt'] },
            '/',
            { name: 'basicstyles', items: ['Bold', 'Italic', 'Underline', 'Strike', 'Subscript', 'Superscript', '-', 'CopyFormatting', 'RemoveFormat'] },
            { name: 'paragraph', items: ['NumberedList', 'BulletedList', '-', 'Outdent', 'Indent', '-', 'Blockquote', 'CreateDiv', '-', 'JustifyLeft', 'JustifyCenter', 'JustifyRight', 'JustifyBlock', '-', 'BidiLtr', 'BidiRtl'] },
            { name: 'links', items: ['Link', 'Unlink', 'Anchor'] },
            { name: 'insert', items: ['Image', 'Table', 'HorizontalRule', 'Smiley', 'SpecialChar', 'PageBreak', 'Iframe'] },
            '/',
            { name: 'styles', items: ['Styles', 'Format', 'Font', 'FontSize'] },
            { name: 'colors', items: ['TextColor', 'BGColor'] },
            { name: 'tools', items: ['Maximize', 'ShowBlocks'] }
        ],
        
        // Allow all HTML content
        allowedContent: true,
        
        // Font sizes
        fontSize_sizes: '8/8px;9/9px;10/10px;11/11px;12/12px;14/14px;16/16px;18/18px;20/20px;22/22px;24/24px;26/26px;28/28px;36/36px;48/48px;72/72px',
        
        // Font families
        font_names: 'Arial/Arial, Helvetica, sans-serif;' +
            'Comic Sans MS/Comic Sans MS, cursive;' +
            'Courier New/Courier New, Courier, monospace;' +
            'Georgia/Georgia, serif;' +
            'Lucida Sans Unicode/Lucida Sans Unicode, Lucida Grande, sans-serif;' +
            'Tahoma/Tahoma, Geneva, sans-serif;' +
            'Times New Roman/Times, serif;' +
            'Trebuchet MS/Trebuchet MS, Helvetica, sans-serif;' +
            'Verdana/Verdana, Geneva, sans-serif',
        
        // Format tags
        format_tags: 'p;h1;h2;h3;h4;h5;h6;pre;address;div',
        
        // Remove plugins we don't need
        removePlugins: 'elementspath',
        
        // Resize options
        resize_enabled: true,
        resize_dir: 'vertical',
        
        // Remove dialog tabs we don't need
        removeDialogTabs: 'image:advanced;link:advanced',
        
        // Code snippet plugin config
        codeSnippet_theme: 'monokai_sublime',
        
        // Image upload configuration
        filebrowserUploadUrl: '/admin/upload/image',
        filebrowserUploadMethod: 'form',
        
        // Styling
        contentsCss: [
            'https://cdn.ckeditor.com/4.22.1/full/contents.css',
            'https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css'
        ]
    });

    // Load content into CKEditor when ready
    editor.on('instanceReady', function() {
        console.log('‚úÖ CKEditor loaded successfully');
        
        // Set the initial content
        if (initialContent && initialContent.trim() !== '') {
            editor.setData(initialContent);
            console.log('‚úÖ Content loaded into CKEditor, length:', initialContent.length);
        } else {
            console.log('‚ö†Ô∏è No initial content found');
        }
        
        console.log('üìÑ CKEditor content after load:', editor.getData().length);
    });

    // Sync CKEditor data before form submit - CRITICAL!
    document.querySelector('form').addEventListener('submit', function(e) {
        e.preventDefault(); // Prevent default submit first
        
        console.log('üìù Form submitting...');
        console.log('üìã CKEditor content:', editor.getData());
        
        // Method 1: Update using updateElement()
        editor.updateElement();
        
        // Method 2: Manually set textarea value (backup method)
        var textarea = document.getElementById('content');
        textarea.value = editor.getData();
        
        console.log('‚úÖ Textarea value after sync:', textarea.value);
        console.log('üìä Content length:', textarea.value.length);
        
        // Now submit the form
        e.target.submit();
    });
</script>

<style>
    /* CKEditor 4 custom styling */
    .cke_chrome {
        border: 1px solid #d1d5db !important;
        border-radius: 0.375rem;
    }
    .cke_top {
        background: #f9fafb !important;
        border-bottom: 1px solid #e5e7eb !important;
    }
</style>

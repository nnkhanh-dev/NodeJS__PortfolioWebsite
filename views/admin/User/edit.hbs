<div class="container mx-auto px-4 py-8">
  <div class="max-w-3xl mx-auto">
    <div class="bg-white rounded-lg shadow-md p-6">
      <h1 class="text-3xl font-bold text-gray-800 mb-6">Cập nhật thông tin cá nhân</h1>

      {{#if success}}
        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
          <strong class="font-bold">Thành công!</strong>
          <span class="block sm:inline">Thông tin cá nhân đã được cập nhật.</span>
        </div>
      {{/if}}

      {{#if error}}
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
          <strong class="font-bold">Lỗi!</strong>
          <span class="block sm:inline">{{error}}</span>
        </div>
      {{/if}}

      <form action="/admin/user/edit" method="POST" enctype="multipart/form-data" class="space-y-6">
        <!-- Thông tin cơ bản -->
        <div class="border-b pb-6">
          <h2 class="text-xl font-semibold text-gray-700 mb-4">Thông tin cơ bản</h2>
          
          <!-- Tên -->
          <div class="mb-4">
            <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
              Họ và tên 
            </label>
            <input 
              type="text" 
              id="name" 
              name="name" 
              value="{{profile.name}}"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
          </div>

          <!-- Email -->
          <div class="mb-4">
            <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
              Email 
            </label>
            <input 
              type="email" 
              id="email" 
              name="email" 
              value="{{profile.email}}"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
          </div>

          <!-- Vị trí -->
          <div class="mb-4">
            <label for="position" class="block text-sm font-medium text-gray-700 mb-2">
              Vị trí/Chức danh
            </label>
            <input 
              type="text" 
              id="position" 
              name="position" 
              value="{{profile.position}}"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
          </div>

          <!-- Mô tả -->
          <div class="mb-4">
            <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
              Mô tả bản thân
            </label>
            <textarea 
              id="description" 
              name="description"
              required 
              rows="4"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >{{profile.description}}</textarea>
          </div>
        </div>

        <!-- Ảnh đại diện và CV -->
        <div class="border-b pb-6">
          <h2 class="text-xl font-semibold text-gray-700 mb-4">Media</h2>

          <!-- Avatar Upload -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Ảnh đại diện
            </label>
            
            <!-- Current Avatar -->
            {{#if profile.avatar}}
              <div class="mb-3 flex items-center gap-4">
                <img src="{{profile.avatar}}" alt="Current Avatar" class="w-32 h-32 object-cover rounded-full border-2 border-gray-300 shadow-md">
                <div>
                  <p class="text-sm text-gray-600 mb-1">Ảnh đại diện hiện tại</p>
                  <p class="text-xs text-gray-500">Click hoặc kéo thả ảnh mới để thay đổi</p>
                </div>
              </div>
            {{else}}
              <div class="mb-3">
                <p class="text-sm text-gray-500 italic">Chưa có ảnh đại diện</p>
              </div>
            {{/if}}

            <!-- Drop Area -->
            <div id="avatarDropArea" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500 transition">
              <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
              <p class="text-gray-600">Kéo thả ảnh vào đây hoặc click để chọn</p>
              <p class="text-sm text-gray-500 mt-1">Chấp nhận: JPG, PNG, GIF, WEBP (Tối đa 10MB)</p>
            </div>
            <input type="file" id="avatarInput" name="avatar" accept="image/*" class="hidden">
            
            <!-- Preview -->
            <div id="avatarPreview" class="mt-4 hidden">
              <p class="text-sm text-gray-600 mb-2">Ảnh mới:</p>
              <div class="relative inline-block">
                <img id="avatarPreviewImg" src="" alt="Avatar Preview" class="w-32 h-32 object-cover rounded-full border-2 border-blue-500">
                <button type="button" id="removeAvatar" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600">
                  <i class="fas fa-times text-xs"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Resume Upload -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              CV/Resume (PDF)
            </label>
            
            <!-- Current Resume -->
            {{#if profile.resume}}
              <div class="mb-3 flex items-center gap-4">
                <div class="flex-1">
                  <p class="text-sm text-gray-600 mb-2">CV hiện tại đã được tải lên</p>
                  <a href="{{profile.resume}}" target="_blank" class="inline-flex items-center px-5 py-2.5 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all shadow-md hover:shadow-lg">
                    <i class="fas fa-file-pdf mr-2"></i>
                    <span class="font-medium">Xem CV của tôi</span>
                    <i class="fas fa-external-link-alt ml-2 text-xs"></i>
                  </a>
                </div>
              </div>
            {{else}}
              <div class="mb-3">
                <p class="text-sm text-gray-500 italic">Chưa có CV/Resume</p>
              </div>
            {{/if}}

            <!-- Drop Area -->
            <div id="resumeDropArea" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500 transition">
              <i class="fas fa-file-pdf text-4xl text-gray-400 mb-2"></i>
              <p class="text-gray-600">Kéo thả file PDF vào đây hoặc click để chọn</p>
              <p class="text-sm text-gray-500 mt-1">Chỉ chấp nhận file PDF (Tối đa 10MB)</p>
            </div>
            <input type="file" id="resumeInput" name="resume" accept="application/pdf" class="hidden">
            
            <!-- Preview -->
            <div id="resumePreview" class="mt-4 hidden">
              <p class="text-sm text-gray-600 mb-2">CV mới:</p>
              <div class="inline-flex items-center px-4 py-2 bg-green-100 text-green-700 rounded-md">
                <i class="fas fa-file-pdf mr-2"></i>
                <span id="resumeFileName"></span>
                <button type="button" id="removeResume" class="ml-3 text-red-500 hover:text-red-700">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Đổi mật khẩu -->
        <div class="border-b pb-6">
          <h2 class="text-xl font-semibold text-gray-700 mb-4">Đổi mật khẩu</h2>
          <p class="text-sm text-gray-600 mb-4">Để trống nếu không muốn đổi mật khẩu</p>

          <!-- Mật khẩu hiện tại -->
          <div class="mb-4">
            <label for="currentPassword" class="block text-sm font-medium text-gray-700 mb-2">
              Mật khẩu hiện tại
            </label>
            <input 
              type="password" 
              id="currentPassword" 
              name="currentPassword"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
          </div>

          <!-- Mật khẩu mới -->
          <div class="mb-4">
            <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-2">
              Mật khẩu mới
            </label>
            <input 
              type="password" 
              id="newPassword" 
              name="newPassword"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
          </div>

          <!-- Xác nhận mật khẩu mới -->
          <div class="mb-4">
            <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-2">
              Xác nhận mật khẩu mới
            </label>
            <input 
              type="password" 
              id="confirmPassword" 
              name="confirmPassword"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
          </div>
        </div>

        <!-- Nút submit -->
        <div class="flex justify-end space-x-4">
          <a href="/admin/dashboard" class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition">
            Hủy
          </a>
          <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
            Cập nhật thông tin
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // ===== AVATAR UPLOAD =====
  const avatarDropArea = document.getElementById('avatarDropArea');
  const avatarInput = document.getElementById('avatarInput');
  const avatarPreview = document.getElementById('avatarPreview');
  const avatarPreviewImg = document.getElementById('avatarPreviewImg');
  const removeAvatarBtn = document.getElementById('removeAvatar');

  // Click to select file
  avatarDropArea.addEventListener('click', () => avatarInput.click());

  // Drag and drop events
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    avatarDropArea.addEventListener(eventName, preventDefaults, false);
  });

  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  ['dragenter', 'dragover'].forEach(eventName => {
    avatarDropArea.addEventListener(eventName, () => {
      avatarDropArea.classList.add('border-blue-500', 'bg-blue-50');
    });
  });

  ['dragleave', 'drop'].forEach(eventName => {
    avatarDropArea.addEventListener(eventName, () => {
      avatarDropArea.classList.remove('border-blue-500', 'bg-blue-50');
    });
  });

  avatarDropArea.addEventListener('drop', handleAvatarDrop);
  avatarInput.addEventListener('change', handleAvatarSelect);

  function handleAvatarDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    if (files.length > 0) {
      avatarInput.files = files;
      previewAvatar(files[0]);
    }
  }

  function handleAvatarSelect(e) {
    const files = e.target.files;
    if (files.length > 0) {
      previewAvatar(files[0]);
    }
  }

  function previewAvatar(file) {
    // Validate file type
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
    if (!validTypes.includes(file.type)) {
      alert('Chỉ chấp nhận file ảnh (JPEG, PNG, GIF, WEBP)');
      avatarInput.value = '';
      return;
    }

    // Validate file size (10MB)
    if (file.size > 10 * 1024 * 1024) {
      alert('Kích thước file không được vượt quá 10MB');
      avatarInput.value = '';
      return;
    }

    // Show preview
    const reader = new FileReader();
    reader.onload = function(e) {
      avatarPreviewImg.src = e.target.result;
      avatarPreview.classList.remove('hidden');
    };
    reader.readAsDataURL(file);
  }

  removeAvatarBtn.addEventListener('click', () => {
    avatarInput.value = '';
    avatarPreview.classList.add('hidden');
    avatarPreviewImg.src = '';
  });

  // ===== RESUME UPLOAD =====
  const resumeDropArea = document.getElementById('resumeDropArea');
  const resumeInput = document.getElementById('resumeInput');
  const resumePreview = document.getElementById('resumePreview');
  const resumeFileName = document.getElementById('resumeFileName');
  const removeResumeBtn = document.getElementById('removeResume');

  // Click to select file
  resumeDropArea.addEventListener('click', () => resumeInput.click());

  // Drag and drop events
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    resumeDropArea.addEventListener(eventName, preventDefaults, false);
  });

  ['dragenter', 'dragover'].forEach(eventName => {
    resumeDropArea.addEventListener(eventName, () => {
      resumeDropArea.classList.add('border-blue-500', 'bg-blue-50');
    });
  });

  ['dragleave', 'drop'].forEach(eventName => {
    resumeDropArea.addEventListener(eventName, () => {
      resumeDropArea.classList.remove('border-blue-500', 'bg-blue-50');
    });
  });

  resumeDropArea.addEventListener('drop', handleResumeDrop);
  resumeInput.addEventListener('change', handleResumeSelect);

  function handleResumeDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    if (files.length > 0) {
      resumeInput.files = files;
      previewResume(files[0]);
    }
  }

  function handleResumeSelect(e) {
    const files = e.target.files;
    if (files.length > 0) {
      previewResume(files[0]);
    }
  }

  function previewResume(file) {
    // Validate file type
    if (file.type !== 'application/pdf') {
      alert('Chỉ chấp nhận file PDF');
      resumeInput.value = '';
      return;
    }

    // Validate file size (10MB)
    if (file.size > 10 * 1024 * 1024) {
      alert('Kích thước file không được vượt quá 10MB');
      resumeInput.value = '';
      return;
    }

    // Show preview
    resumeFileName.textContent = file.name;
    resumePreview.classList.remove('hidden');
  }

  removeResumeBtn.addEventListener('click', () => {
    resumeInput.value = '';
    resumePreview.classList.add('hidden');
    resumeFileName.textContent = '';
  });

  // ===== PASSWORD VALIDATION =====
  const form = document.querySelector('form');
  form.addEventListener('submit', function(e) {
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    // Nếu có nhập bất kỳ trường mật khẩu nào
    if (currentPassword || newPassword || confirmPassword) {
      if (!currentPassword) {
        e.preventDefault();
        alert('Vui lòng nhập mật khẩu hiện tại để đổi mật khẩu');
        return;
      }
      if (!newPassword) {
        e.preventDefault();
        alert('Vui lòng nhập mật khẩu mới');
        return;
      }
      if (newPassword !== confirmPassword) {
        e.preventDefault();
        alert('Mật khẩu mới và xác nhận mật khẩu không khớp');
        return;
      }
      if (newPassword.length < 6) {
        e.preventDefault();
        alert('Mật khẩu mới phải có ít nhất 6 ký tự');
        return;
      }
    }
  });
</script>
